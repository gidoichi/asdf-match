#!/bin/sh

set -eu
PARENT="$(d=${0%/*}/; [ "_$d" = "_$0/" ] && d='./'; cd "$d."; pwd)"

debug() {
    (PS4=''; set -x; : "$@")
    res=$("$@")
    ret=$?
    if [ -n "$res" ]; then
        printf '%s\n' "$res" | tee /dev/stderr
    fi
    return "$ret"
}

load_plugins() {
    eval "$(find "${PARENT}/../plugins" -name '*.sh' | xargs cat)"
}

to_upper_snake_case() {
    tr 'a-z-' 'A-Z_' | grep '^[A-Z_]*$'
}

current_version() {
    plugin=$1
    PLUGIN=$(printf '%s' "$plugin" | to_upper_snake_case)
    ASDFMATCH_CURRENT_VER_FUNC='"${ASDFMATCH_CURRENT_VER_FUNC_'"$PLUGIN"'}"'
    if (eval : "$ASDFMATCH_CURRENT_VER_FUNC" 2>/dev/null); then
        eval debug "$ASDFMATCH_CURRENT_VER_FUNC"
    else
        current=$(debug asdf current "$plugin")
        printf '%s' "$current" | awk '{print $2}'
    fi
}

desired_version() {
    plugin=$1
    PLUGIN=$(printf '%s' "$plugin" | to_upper_snake_case)
    ASDFMATCH_DESIRED_VER_FUNC='"${ASDFMATCH_DESIRED_VER_FUNC_'"$PLUGIN"'}"'
    eval debug "$ASDFMATCH_DESIRED_VER_FUNC"
}

use() {
    plugin=$1
    version=$2
    if ! asdf current "$plugin" >/dev/null; then
        debug asdf plugin add "$package"
    fi
    if ! asdf list "$plugin" "$version" >/dev/null; then
        debug asdf install "$package" "$version"
    fi
    debug asdf global "$package" "$version"
}

load_plugins

package=$1
desired=$(desired_version "$package")
current=$(current_version "$package")
if [ "$current" = "$desired" ]; then
    exit
fi

use "$package" "$desired"
current=$(current_version "$package")
test "$current" = "$desired"
